name: Auto Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.SERVER_HOST || vars.SERVER_HOST }}
      DEPLOY_PORT: ${{ secrets.SERVER_PORT || vars.SERVER_PORT }}
      DEPLOY_USER: ${{ secrets.SERVER_USER || vars.SERVER_USER }}
      DEPLOY_KEY: ${{ secrets.SERVER_SSH_KEY || vars.SERVER_SSH_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy inputs
        run: |
          if [ -z "${DEPLOY_HOST}" ]; then echo "WARN: SERVER_HOST is empty"; fi
          if [ -z "${DEPLOY_USER}" ]; then echo "WARN: SERVER_USER is empty"; fi
          if [ -z "${DEPLOY_KEY}" ]; then echo "WARN: SERVER_SSH_KEY is empty"; fi
          if [ -z "${DEPLOY_PORT}" ]; then
            echo "SERVER_PORT is empty, default to 22"
            echo "DEPLOY_PORT=22" >> "$GITHUB_ENV"
          fi

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${DEPLOY_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Ensure rsync on runner
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Ensure remote project dir
        run: |
          port="${DEPLOY_PORT:-22}"
          if [ -z "${DEPLOY_HOST}" ] || [ -z "${DEPLOY_USER}" ] || [ -z "${DEPLOY_KEY}" ]; then
            echo "Skip creating remote dir due to missing deploy inputs"
            exit 0
          fi
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" "mkdir -p /root/.openclaw/workspace/oldboyapp"

      - name: Run deploy on server
        id: deploy_step
        continue-on-error: true
        shell: bash
        run: |
          set +e
          set -o pipefail
          port="${DEPLOY_PORT:-22}"
          if [ -z "${DEPLOY_HOST}" ] || [ -z "${DEPLOY_USER}" ] || [ -z "${DEPLOY_KEY}" ]; then
            echo "Invalid deploy inputs: host_present='$([ -n "${DEPLOY_HOST}" ] && echo yes || echo no)' user_present='$([ -n "${DEPLOY_USER}" ] && echo yes || echo no)' key_present='$([ -n "${DEPLOY_KEY}" ] && echo yes || echo no)'" | tee deploy_output.log
            code=99
          else
            target="${DEPLOY_USER}@${DEPLOY_HOST}"
            ssh_opts="-o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p ${port}"
            rsync -az --delete --exclude='.git' --exclude='.github' --exclude='frontend/node_modules' --exclude='frontend/dist' --exclude='backend/.venv' --exclude='backend/db.sqlite3' --exclude='deploy/env.prod' -e "ssh ${ssh_opts}" ./ "${target}:/root/.openclaw/workspace/oldboyapp/" 2>&1 | tee deploy_output.log
            sync_code=${PIPESTATUS[0]}
            if [ "${sync_code}" -ne 0 ]; then
              echo "rsync failed, fallback to tar over ssh" | tee -a deploy_output.log
              tar --exclude='.git' --exclude='.github' --exclude='frontend/node_modules' --exclude='frontend/dist' --exclude='backend/.venv' --exclude='backend/db.sqlite3' --exclude='deploy/env.prod' -czf - . \
                | ssh ${ssh_opts} "${target}" "mkdir -p /root/.openclaw/workspace/oldboyapp && tar -xzf - -C /root/.openclaw/workspace/oldboyapp" 2>&1 | tee -a deploy_output.log
              sync_code=${PIPESTATUS[1]}
            fi
            if [ "${sync_code}" -ne 0 ]; then
              code=${sync_code}
            else
              ssh ${ssh_opts} "${target}" "cd /root/.openclaw/workspace/oldboyapp && bash scripts/server_deploy.sh" 2>&1 | tee -a deploy_output.log
              code=${PIPESTATUS[0]}
            fi
          fi
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Collect server logs on failure
        if: steps.deploy_step.outputs.exit_code != '0'
        run: |
          port="${DEPLOY_PORT:-22}"
          if [ -z "${DEPLOY_HOST}" ] || [ -z "${DEPLOY_USER}" ] || [ -z "${DEPLOY_KEY}" ]; then
            echo "Skip server log collection due to missing deploy inputs" > deploy_logs.txt
          else
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" "cd /root/.openclaw/workspace/oldboyapp/deploy && echo '## docker compose ps' && docker compose --env-file env.prod ps && echo && echo '## backend logs' && docker compose --env-file env.prod logs --tail=300 backend && echo && echo '## nginx logs' && docker compose --env-file env.prod logs --tail=300 nginx" > deploy_logs.txt 2>&1 || true
          fi

      - name: Build failure report
        if: steps.deploy_step.outputs.exit_code != '0'
        run: |
          {
            echo "# Auto Deploy Failed"
            echo
            echo "- Commit: ${{ github.sha }}"
            echo "- Actor: ${{ github.actor }}"
            echo "- Workflow: ${{ github.workflow }}"
            echo "- Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "- Exit code: ${{ steps.deploy_step.outputs.exit_code }}"
            echo
            echo "## Deploy Output"
            echo '```text'
            cat deploy_output.log || true
            echo '```'
            echo
            echo "## Server Logs"
            echo '```text'
            cat deploy_logs.txt || true
            echo '```'
          } > deploy_failure_report.md

      - name: Create GitHub issue on failure
        if: steps.deploy_step.outputs.exit_code != '0'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "[Auto Deploy Failed] ${{ github.sha }}"
          content-filepath: deploy_failure_report.md
          labels: bug,deploy-failed

      - name: Fail job if deploy failed
        if: steps.deploy_step.outputs.exit_code != '0'
        run: |
          echo "Deployment failed on server"
          exit 1
